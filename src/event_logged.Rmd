---
title: "Event Study (Logged HPPD) Results"
author: "Joe White"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
    toc: false
    number_sections: false
  html_document:
    toc: false
    df_print: paged
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 3)

suppressPackageStartupMessages({
  library(fixest)
  library(readr)
  library(dplyr)
  library(tidyr)
  library(modelsummary)
})
```

```{r data-setup, include=FALSE, results='hide', message=FALSE, warning=FALSE}
# === Load panel ===
panel_fp <- "C:/Repositories/white-bowblis-nhmc/data/clean/analytical_panel.csv"

keep_cols <- c(
  "cms_certification_number","year_month",
  "event_time","treatment",
  "government","non_profit","chain","ccrc_facility",
  "sff_facility","cm_q_state_2","cm_q_state_3","cm_q_state_4","urban",
  "rn_hppd","lpn_hppd","cna_hppd","total_hppd"
)

df <- read_csv(panel_fp, show_col_types = FALSE, col_select = all_of(keep_cols)) %>%
  mutate(
    year_month = as.character(year_month),
    cms_certification_number = as.factor(cms_certification_number)
  )

# === Ever-treated flag ===
df <- df %>%
  group_by(cms_certification_number) %>%
  mutate(ever_treated = as.integer(any(treatment == 1, na.rm = TRUE) | any(!is.na(event_time)))) %>%
  ungroup()

# === Capped/sentinel event time ===
df <- df %>%
  mutate(
    event_time_capped = dplyr::case_when(
      ever_treated == 1L & !is.na(event_time) ~ pmin(pmax(event_time, -24L), 24L),
      TRUE                                    ~ 9999L
    )
  )

# === Helper: run ES with logged LHS, FE, and 2-way clustered SEs ===
run_es <- function(lhs) {
  df_lhs <- df %>% filter(!is.na(.data[[lhs]]), .data[[lhs]] > 0)
  cat(sprintf("[info] %s: using %d rows after LHS>0 filter\n", lhs, nrow(df_lhs)))
  feols(
    as.formula(paste0(
      "log(", lhs, ") ~ i(event_time_capped, ever_treated, ref = -1, keep = -24:24) + ",
      "government + non_profit + chain + ccrc_facility + sff_facility + ",
      "cm_q_state_2 + cm_q_state_3 + cm_q_state_4 + urban",
      " | cms_certification_number + year_month"
    )),
    data = df_lhs,
    vcov = ~ cms_certification_number + year_month,
    lean = TRUE
  )
}

# === Fit four outcomes ===
m_rn  <- run_es("rn_hppd")
m_lpn <- run_es("lpn_hppd")
m_cna <- run_es("cna_hppd")
m_tot <- run_es("total_hppd")

models <- list(
  "log(RN HPPD)"    = m_rn,
  "log(LPN HPPD)"   = m_lpn,
  "log(CNA HPPD)"   = m_cna,
  "log(Total HPPD)" = m_tot
)
```

## Results

```{r formatted-table, results='asis'}
# Optional mapping for cleaner control labels (event-time rows left as-is)
coef_map <- c(
  "government"    = "Government",
  "non_profit"    = "Non-profit",
  "chain"         = "Chain",
  "ccrc_facility" = "CCRC",
  "sff_facility"  = "SFF",
  "cm_q_state_2"  = "Case-mix Q2 (state×mth)",
  "cm_q_state_3"  = "Case-mix Q3 (state×mth)",
  "cm_q_state_4"  = "Case-mix Q4 (state×mth)",
  "urban"         = "Urban"
)

modelsummary(
  models,
  estimate  = "{estimate} ({std.error})",
  statistic = NULL,
  coef_map  = coef_map,
  gof_omit  = "IC|Log|Adj|Within|Between|Std.Errors|FE",
  add_rows  = data.frame(
    term                = c("Facility FE", "Month FE", "SE type"),
    `log(RN HPPD)`      = c("Yes", "Yes", "2-way clustered"),
    `log(LPN HPPD)`     = c("Yes", "Yes", "2-way clustered"),
    `log(CNA HPPD)`     = c("Yes", "Yes", "2-way clustered"),
    `log(Total HPPD)`   = c("Yes", "Yes", "2-way clustered")
  ),
  title = "Event-Study with Logged Outcomes",
  output = "markdown"
)
```

## Raw Model Summaries

```{r raw-summaries, echo=TRUE}
summary(m_rn)
summary(m_lpn)
summary(m_cna)
summary(m_tot)
```

## Event-Study Plots

```{r plot-rn, fig.width=7, fig.height=4}
iplot(m_rn,  ref = -1, xlim = c(-24, 24),
      xlab = "Months relative to CHOW",
      ylab = "log RN HPPD",
      main = "ES (log): RN")
```

```{r plot-lpn, fig.width=7, fig.height=4}
iplot(m_lpn, ref = -1, xlim = c(-24, 24),
      xlab = "Months relative to CHOW",
      ylab = "log LPN HPPD",
      main = "ES (log): LPN")
```

```{r plot-cna, fig.width=7, fig.height=4}
iplot(m_cna, ref = -1, xlim = c(-24, 24),
      xlab = "Months relative to CHOW",
      ylab = "log CNA HPPD",
      main = "ES (log): CNA")
```

```{r plot-total, fig.width=7, fig.height=4}
iplot(m_tot, ref = -1, xlim = c(-24, 24),
      xlab = "Months relative to CHOW",
      ylab = "log Total HPPD",
      main = "ES (log): Total")
```
