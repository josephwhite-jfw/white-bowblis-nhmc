---
title: "TWFE Sensitivity Analysis"
author: "Joe White"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    latex_engine: pdflatex
    toc: false
    number_sections: false
    keep_tex: true
fontsize: 11pt
geometry: margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 3, fixest_nthreads = 4, width = 120)

suppressPackageStartupMessages({
  library(fixest)
  library(readr)
  library(dplyr)
})
```

```{r sensitivity-raw-summaries, results='asis'}
# ============================== CONFIG ================================
# Choose which outcomes to print. Options: "rn", "lpn", "cna", "total".
# Examples:
#   OUT_SELECT <- c("total")          # only Total (default)
#   OUT_SELECT <- c("lpn")            # only LPN
#   OUT_SELECT <- c("cna")            # only CNA
#   OUT_SELECT <- c("rn","lpn")       # RN and LPN
OUT_SELECT <- c("total")

# Choose transforms to print: "level" and/or "log"
TRANSFORMS <- c("level", "log")
# =====================================================================

# Helper: emit a fenced code block (safe for LaTeX/PDF)
emit_block <- function(lines) {
  cat("``````\n", paste(lines, collapse = "\n"), "\n``````\n\n", sep = "")
}

# ------------------------------ Load ---------------------------------
panel_fp <- "C:/Repositories/white-bowblis-nhmc/data/clean/panel.csv"
df <- read_csv(panel_fp, show_col_types = FALSE)

# Basic types + a date helper
df <- df %>%
  mutate(
    cms_certification_number = as.factor(cms_certification_number),
    year_month = as.character(year_month),
    ym_date = as.Date(paste0(gsub("/", "-", year_month), "-01"))
  )

# Log outcomes (only if positive)
mk_log <- function(x) ifelse(x > 0, log(x), NA_real_)
df <- df %>%
  mutate(
    ln_rn    = mk_log(rn_hppd),
    ln_lpn   = mk_log(lpn_hppd),
    ln_cna   = mk_log(cna_hppd),
    ln_total = mk_log(total_hppd)
  )

# ------------------------------ Spec ---------------------------------
controls <- paste(
  "government + non_profit + chain + beds +",
  "occupancy_rate + pct_medicare + pct_medicaid +",
  "cm_q_state_2 + cm_q_state_3 + cm_q_state_4"
)
rhs <- paste("post +", controls)
make_fml <- function(lhs) as.formula(sprintf("%s ~ %s | cms_certification_number + year_month", lhs, rhs))
vc <- ~ cms_certification_number + year_month

# Outcome selection mapping
name_map <- c(rn = "rn_hppd", lpn = "lpn_hppd", cna = "cna_hppd", total = "total_hppd")
OUT_SELECT <- intersect(OUT_SELECT, names(name_map))
if (length(OUT_SELECT) == 0L) OUT_SELECT <- "total"
outs <- unname(name_map[OUT_SELECT])

# Transform mapping
xfms <- c(level = "%s", log = "ln_%s")
TRANSFORMS <- intersect(TRANSFORMS, names(xfms))
if (length(TRANSFORMS) == 0L) TRANSFORMS <- "level"

# ---------------------------- Scenarios ------------------------------
baseline_window <- df %>%
  filter(ym_date >= as.Date("2017-01-01"), ym_date <= as.Date("2017-03-31")) %>%
  arrange(cms_certification_number, ym_date) %>%
  group_by(cms_certification_number) %>%
  summarise(baseline_chain_2017Q1 = dplyr::first(chain), .groups = "drop")

df <- df %>% left_join(baseline_window, by = "cms_certification_number")

#make_pre_pandemic <- function(d) d %>% filter(ym_date >= as.Date("2017-01-01"), ym_date <= as.Date("2019-12-31"))
#make_pandemic     <- function(d) d %>% filter(ym_date >= as.Date("2020-04-01"), ym_date <= as.Date("2024-06-30"))
make_for_profit   <- function(d) d %>% filter(government == 0, non_profit == 0)
make_non_profit   <- function(d) d %>%filter(government == 0, non_profit == 1)
#make_chain17      <- function(d) d %>% filter(!is.na(baseline_chain_2017Q1), baseline_chain_2017Q1 == 1)
#make_nonchain17   <- function(d) d %>% filter(!is.na(baseline_chain_2017Q1), baseline_chain_2017Q1 == 0)

scenarios <- list(
  #"pre_pandemic_2017_2019"   = make_pre_pandemic,
  #"pandemic_2020q2_2024q2"   = make_pandemic,
  "for_profit_only"          = make_for_profit,
  "non_profit_only"          = make_non_profit # make sure to add , back
  #"baseline_chain_2017q1"    = make_chain17,
  #"baseline_nonchain_2017q1" = make_nonchain17
)

# ------------------------------ Samples ------------------------------
sample_slicers <- list(
  "with_anticipation"        = function(d) d,
  "without_anticipation"  = function(d) d %>% filter(anticipation2 == 0)
)

# ------------------------------ Run ----------------------------------
for (sc_name in names(scenarios)) {
  cat(sprintf("## SCENARIO: %s\n\n", sc_name))
  d_sc <- scenarios[[sc_name]](df)

  for (samp_name in names(sample_slicers)) {
    d_samp <- sample_slicers[[samp_name]](d_sc)

    if (!nrow(d_samp)) {
      cat(sprintf("### SAMPLE: %s\n\n", samp_name))
      emit_block("[info] No data in this sample.")
      next
    }

    n_rows <- nrow(d_samp)
    n_ccn  <- dplyr::n_distinct(d_samp$cms_certification_number)
    cat(sprintf("### SAMPLE: %s\n\n", samp_name))
    emit_block(sprintf("[info] rows=%s | CCNs=%s", format(n_rows, big.mark=","), n_ccn))

    for (y in outs) {
      for (tname in TRANSFORMS) {
        lhs <- if (tname == "level") y else sprintf(xfms[[tname]], sub("_hppd$", "", y))
        if (all(is.na(d_samp[[lhs]]))) {
          emit_block(sprintf("[skip] %s %s (all NA)", tname, y))
          next
        }

        m <- feols(fml = make_fml(lhs), data = d_samp, vcov = vc, lean = TRUE)

        cat(sprintf("#### OUTCOME: %s (%s)\n\n", y, tname))
        emit_block(capture.output(summary(m)))
      }
    }
  }
}

cat("\nDone.\n")
```