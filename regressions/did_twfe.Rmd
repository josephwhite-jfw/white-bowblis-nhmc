---
title: "Table 1 — TWFE Post Estimates"
author: "Joe White"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
    toc: false
    number_sections: false
fontsize: 11pt
geometry: margin=1in
header-includes:
  - \usepackage{booktabs}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999, digits = 3)

suppressPackageStartupMessages({
library(fixest)
library(dplyr)
library(readr)
library(kableExtra)
})
```

```{r table1, results='asis'}
cat("[info] loading panel...\n")
panel_fp <- "C:/Repositories/white-bowblis-nhmc/data/clean/panel.csv"
df <- read_csv(panel_fp, show_col_types = FALSE)

need_cols <- c(
"cms_certification_number","year_month","post",
"anticipation1","anticipation2",
"rn_hppd","lpn_hppd","cna_hppd","total_hppd",
"government","non_profit","chain","beds",
"occupancy_rate","pct_medicare","pct_medicaid",
"cm_q_state_2","cm_q_state_3","cm_q_state_4"
)
stopifnot(all(need_cols %in% names(df)))

cat("[info] building log outcomes...\n")
mk_log <- function(x) ifelse(x > 0, log(x), NA_real_)
df <- df %>%
mutate(
ln_rn    = mk_log(rn_hppd),
ln_lpn   = mk_log(lpn_hppd),
ln_cna   = mk_log(cna_hppd),
ln_total = mk_log(total_hppd)
)

controls <- paste(
"government + non_profit + chain + beds +",
"occupancy_rate + pct_medicare + pct_medicaid +",
"cm_q_state_2 + cm_q_state_3 + cm_q_state_4"
)
rhs <- paste("post +", controls)
make_fml <- function(lhs) as.formula(
sprintf("%s ~ %s | cms_certification_number + year_month", lhs, rhs)
)

specs <- list(
"With anticipation"      = df,
"Donut A1 (drop -3..2)"  = dplyr::filter(df, anticipation1 == 0),
"Donut A2 (drop -3..-1)" = dplyr::filter(df, anticipation2 == 0)
)

outs_level <- c(RN="rn_hppd", LPN="lpn_hppd", CNA="cna_hppd", Total="total_hppd")
outs_log   <- c(RN="ln_rn",   LPN="ln_lpn",   CNA="ln_cna",   Total="ln_total")

fmt_cell <- function(m, term="post") {
b  <- tryCatch(unname(coef(m)[term]),     error=function(e) NA_real_)
se <- tryCatch(sqrt(diag(vcov(m)))[term], error=function(e) NA_real_)
if (is.na(b) || is.na(se)) return("")
t  <- b / se
p  <- 2 * pnorm(-abs(t))
star <- ifelse(p < 0.01, "***", ifelse(p < 0.05, "**", ifelse(p < 0.10, "*","")))
sprintf("%.3f\n(%.3f)%s", b, se, star)
}

fit_block <- function(spec_list, outcomes) {
res <- matrix("", nrow=length(spec_list), ncol=length(outcomes),
dimnames=list(names(spec_list), names(outcomes)))
ii <- 0L
for (i in seq_along(spec_list)) {
dsub <- spec_list[[i]]
for (j in seq_along(outcomes)) {
ii <- ii + 1L
cat(sprintf("[fit] %d/%d: %s × %s\n",
ii, length(spec_list)*length(outcomes),
names(spec_list)[i], names(outcomes)[j]))
lhs <- outcomes[[j]]
m <- feols(
fml  = make_fml(lhs),
data = dsub,
vcov = ~ cms_certification_number + year_month
)
res[i, j] <- fmt_cell(m, "post")
}
}
res
}

cat("[info] fitting levels...\n")
tabA <- fit_block(specs, outs_level)
cat("[info] fitting logs...\n")
tabB <- fit_block(specs, outs_log)

panelA_df <- cbind(Panel = "Panel A — Levels",
Spec  = rownames(tabA),
as.data.frame(tabA, optional = TRUE))
panelB_df <- cbind(Panel = "Panel B — Logs",
Spec  = rownames(tabB),
as.data.frame(tabB, optional = TRUE))
table_df <- dplyr::bind_rows(panelA_df, panelB_df)

Ns <- lapply(names(specs), function(nm) {
dsub <- specs[[nm]]
mL <- feols(make_fml("total_hppd"), data=dsub, vcov=~cms_certification_number + year_month)
mG <- feols(make_fml("ln_total"),   data=dsub, vcov=~cms_certification_number + year_month)
c(levels = nobs(mL), logs = nobs(mG))
})
Ns <- do.call(rbind, Ns)
rownames(Ns) <- names(specs)

cap <- "Table 1. Two-Way FE (TWFE) estimates of post on staffing outcomes"

cat("[info] rendering table...\n")
kbl(table_df,
format = "latex",
booktabs = TRUE,
caption  = cap,
align = c("l","l","c","c","c","c"),
escape = FALSE
) |>
add_header_above(c(" " = 2, "Outcomes" = 4)) |>
kable_styling(latex_options = c("hold_position")) |>
collapse_rows(columns = 1, latex_hline = "major") |>
footnote(
general = paste0(
"Notes: Entries are coefficients on post with two-way clustered SEs in parentheses. ",
"Panel A shows levels; Panel B shows logs. ",
"Samples: With anticipation (full sample), Donut A1 (drop t in {-3,-2,-1,0,1,2}), ",
"Donut A2 (drop t in {-3,-2,-1}). ",
"Approx. Ns (Total outcome): With anticipation: levels=", Ns['With anticipation','levels'],
", logs=", Ns['With anticipation','logs'],
"; Donut A1: levels=", Ns['Donut A1 (drop -3..2)','levels'],
", logs=", Ns['Donut A1 (drop -3..2)','logs'],
"; Donut A2: levels=", Ns['Donut A2 (drop -3..-1)','levels'],
", logs=", Ns['Donut A2 (drop -3..-1)','logs'], "."
),
threeparttable = TRUE, general_title = ""
)
cat("[done]\n")
```